# 멀티서버 배포 플레이북
# 사용법:
#   전체 배포:       ansible-playbook site.yml
#   앱만 배포:       ansible-playbook site.yml --limit app
#   모니터링만 배포:  ansible-playbook site.yml --limit monitoring
#   Swap 적용:      ansible-playbook site.yml --tags swap

# --- 공통: Docker 설치 + 방화벽 (최초 1회) ---
- name: 공통 설정
  hosts: all
  become: true
  roles:
    - docker
    - firewall

# --- ARM App Server ---
- name: App Server 배포 (ARM)
  hosts: app
  become: true
  vars:
    app_dir: /home/{{ ansible_user }}/wiki-engine/backend
  roles:
    - app

# --- AMD #1: Loki + Grafana ---
- name: Monitoring Loki 배포 (AMD #1)
  hosts: monitoring-loki
  become: true
  vars:
    deploy_dir: /home/{{ ansible_user }}/wiki-engine
  roles:
    - monitoring-loki

# --- AMD #2: Prometheus ---
- name: Monitoring Prometheus 배포 (AMD #2)
  hosts: monitoring-prometheus
  become: true
  vars:
    deploy_dir: /home/{{ ansible_user }}/wiki-engine
  roles:
    - monitoring-prometheus

# --- 전체 Docker 이미지 정리 (배포 후 1회) ---
- name: Docker 이미지 정리
  hosts: all
  become: false
  tasks:
    - name: 미사용 Docker 이미지 정리
      community.docker.docker_prune:
        images: true
        images_filters:
          dangling: true
      tags: [deploy]

# --- Swap (수동 실행, 성능 비교용) ---
# ansible-playbook site.yml --tags swap
- name: Swap 설정 (성능 비교 후 수동 실행)
  hosts: all
  become: true
  roles:
    - swap

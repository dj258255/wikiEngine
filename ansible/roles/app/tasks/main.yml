# App Server 배포 (ARM)
- name: 프로젝트 디렉토리 생성
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: 소스 코드 동기화
  synchronize:
    src: "{{ playbook_dir }}/../backend/"
    dest: "{{ app_dir }}/"
    delete: true
    rsync_opts:
      - "--exclude=.gradle"
      - "--exclude=build"
      - "--exclude=.env.*"
      - "--exclude=.idea"
      - "--exclude=docker-compose.dev.yml"
      - "--exclude=docker-compose.prod.yml"
  become: false
  tags: [deploy]

- name: App Server용 docker-compose.yml 배포
  copy:
    src: docker-compose.yml
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: [deploy]

- name: Promtail 디렉토리 생성
  file:
    path: "{{ app_dir }}/promtail"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: Promtail 설정 생성 (템플릿)
  template:
    src: promtail.yml.j2
    dest: "{{ app_dir }}/promtail/promtail.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: [deploy]

- name: Nginx 디렉토리 생성
  file:
    path: "{{ app_dir }}/nginx"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: Nginx 설정 배포
  copy:
    src: nginx/nginx.conf
    dest: "{{ app_dir }}/nginx/nginx.conf"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: [deploy]

- name: .env.prod 생성
  template:
    src: env.prod.j2
    dest: "{{ app_dir }}/.env.prod"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
  tags: [deploy]

- name: Docker 이미지 빌드
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    env_files: [".env.prod"]
    build: always
    services: [app]
    state: present
  become: false
  tags: [deploy]

- name: MySQL 시작 및 헬스체크 대기
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    env_files: [".env.prod"]
    services: [mysql]
    state: present
    wait: true
    wait_timeout: 120
  become: false
  tags: [deploy]

- name: 전체 서비스 시작
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    env_files: [".env.prod"]
    state: present
    pull: missing
  become: false
  tags: [deploy]

- name: 앱 헬스체크 대기
  uri:
    url: http://localhost:8080/actuator/health
    status_code: 200
  register: health
  until: health.status == 200
  retries: 24
  delay: 5
  tags: [deploy]

- name: 미사용 Docker 이미지 정리
  community.docker.docker_prune:
    images: true
    images_filters:
      dangling: true
  become: false
  tags: [deploy]

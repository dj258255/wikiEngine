# Monitoring Prometheus 배포 (AMD #2)
- name: 프로젝트 디렉토리 생성
  file:
    path: "{{ deploy_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: Monitoring Prometheus 파일 동기화
  synchronize:
    src: "{{ role_path }}/files/"
    dest: "{{ deploy_dir }}/"
    delete: true
  become: false
  tags: [deploy]

- name: Monitoring Prometheus docker-compose.yml 배포
  template:
    src: docker-compose.yml.j2
    dest: "{{ deploy_dir }}/docker-compose.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: Prometheus 디렉토리 생성
  file:
    path: "{{ deploy_dir }}/prometheus"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: [deploy]

- name: Prometheus 설정 생성 (템플릿)
  template:
    src: prometheus.yml.j2
    dest: "{{ deploy_dir }}/prometheus/prometheus.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: [deploy]

- name: 전체 서비스 시작
  community.docker.docker_compose_v2:
    project_src: "{{ deploy_dir }}"
    state: present
    pull: missing
  become: false
  tags: [deploy]

- name: Prometheus 헬스체크 대기
  uri:
    url: http://localhost:9090/-/ready
    status_code: 200
  register: prom_health
  until: prom_health.status == 200
  retries: 12
  delay: 5
  tags: [deploy]

- name: 미사용 Docker 이미지 정리
  community.docker.docker_prune:
    images: true
    images_filters:
      dangling: true
  become: false
  tags: [deploy]
